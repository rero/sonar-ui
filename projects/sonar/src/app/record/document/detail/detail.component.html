<!--
 SONAR User Interface
 Copyright (C) 2020 RERO

 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU Affero General Public License as published by
 the Free Software Foundation, version 3 of the License.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 GNU Affero General Public License for more details.

 You should have received a copy of the GNU Affero General Public License
 along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<ng-container *ngIf="record$ | async as record">
  <h1>
    {{ record.metadata.title[0].mainTitle | languageValue }}
  </h1>
  <h5 *ngIf="record.metadata.title[0].subtitle" class="text-muted">
    {{ record.metadata.title[0].subtitle | languageValue }}
  </h5>
  <dl class="row mt-4">
    <ng-container *ngIf="record.metadata.organisation">
      <dt class="col-sm-3" translate>Organisation</dt>
      <dd class="col-sm-9">{{ record.metadata.organisation.name | translate }}</dd>
    </ng-container>

    <ng-container *ngIf="record.metadata.documentType">
      <dt class="col-sm-3" translate>Document type</dt>
      <dd class="col-sm-9">{{ ('document_type_' + record.metadata.documentType) | translate }}</dd>
    </ng-container>

    <ng-container *ngIf="record.metadata.classification">
      <dt class="col-sm-3" translate>Classification</dt>
      <dd class="col-sm-9">
        {{ ('classification_' + record.metadata.classification[0].classificationPortion) | translate }}
      </dd>
    </ng-container>

    <ng-container *ngIf="record.metadata.identifiedBy">
      <dt class="col-sm-3" translate>Identifier</dt>
      <dd class="col-sm-9">
        <p class="m-0" *ngFor="let identifier of record.metadata.identifiedBy">
          {{ identifier.value }}
          <small class="badge badge-secondary text-uppercase text-light">{{ identifier.type | translate }}</small>
        </p>
      </dd>
    </ng-container>

    <ng-container *ngIf="record.metadata.language">
      <dt class="col-sm-3" translate>Languages</dt>
      <dd class="col-sm-9">
        <span *ngFor="let language of record.metadata.language">
          {{ ('lang-' + language.value) | translate }}
        </span>
      </dd>
    </ng-container>

    <ng-container *ngIf="record.metadata.contribution">
      <dt class="col-sm-3" translate>Contributions</dt>
      <dd class="col-sm-9">
        <ul class="list-unstyled mb-0">
          <li *ngFor="let contribution of record.metadata.contribution; let last = last">
            <small
              class="badge badge-secondary text-uppercase text-light">{{ contribution.agent.type | translate }}</small>
            <small class="badge badge-secondary text-uppercase text-light ml-1"
              *ngFor="let role of contribution.role">{{ role | translate }}</small>
            {{ contribution.agent.preferred_name }}
            <i class="text-muted" *ngIf="contribution.affiliation">({{ contribution.affiliation }})</i>
          </li>
        </ul>
      </dd>
    </ng-container>

    <ng-container *ngIf="record.metadata.type">
      <dt class="col-sm-3" translate>Document type</dt>
      <dd class="col-sm-9 text-justify">
        {{ ('type-' + record.metadata.type) | translate }}
      </dd>
    </ng-container>

    <ng-container *ngIf="record.metadata.copyrightDate">
      <dt class="col-sm-3" translate>Copyright date</dt>
      <dd class="col-sm-9 text-justify">
        {{ record.metadata.copyrightDate | join : ', ' }}
      </dd>
    </ng-container>

    <ng-container *ngIf="record.metadata.abstracts">
      <dt class="col-sm-3" translate>Abstracts</dt>
      <dd class="col-sm-9">
        <p class="m-0 text-justify" *ngFor="let abstract of record.metadata.abstracts">
          <span class="badge badge-secondary text-light mr-2">{{ abstract.language | uppercase }}</span>
          <span [innerHtml]="abstract.value | nl2br"></span>
        </p>
      </dd>
    </ng-container>

    <ng-container *ngIf="record.metadata.subjects && record.metadata.subjects.length">
      <dt class="col-sm-3" translate>Subjects</dt>
      <dd class="col-sm-9">
        <p class="m-0" *ngFor="let subject of record.metadata.subjects">
          <span class="badge badge-secondary text-light mr-2">{{ subject.label.language | uppercase }}</span>
          {{ subject.label.value | join:' ; ' }}
        </p>
      </dd>
    </ng-container>
  </dl>

  <ng-container *ngIf="record.metadata._files">
    <h5 class="mt-5" translate>Files</h5>
    <table class="table">
      <thead>
        <tr>
          <th translate>Label</th>
          <th translate>File</th>
          <th translate>Size</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let file of filterFiles(record.metadata._files)">
          <td>{{ file.label | default:'-' }}</td>
          <td>{{ file.key }}</td>
          <td>{{ file.size | filesize }}</td>
          <td class="text-right">
            <a href (click)="$event.preventDefault(); previewFileKey = file.key; previewModal.show()"
              class="btn btn-secondary btn-sm text-light previewLink mr-2"><i class="fa fa-eye"></i>
              {{ 'Preview' | translate }}</a>
            <a [href]="file.key | fileLink: 'documents':record.metadata.pid:'files'" target="_blank"
              class="btn btn-secondary btn-sm text-light"><i class="fa fa-download"></i>
              {{ 'Download' | translate }}</a>
          </td>
        </tr>
      </tbody>
    </table>
  </ng-container>

  <!--Preview modal-->
  <div bsModal #previewModal="bs-modal" class="modal fade" tabindex="-1" role="dialog"
    aria-labelledby="dialog-sizes-name1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 id="dialog-sizes-name1" class="modal-title pull-left">{{ previewFileKey }}</h4>
          <button type="button" class="close pull-right" (click)="previewModal.hide()" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <iframe class="preview-iframe" id="preview-iframe" width="100%" height="500"
            [src]="previewFileKey | fileLink: 'documents':record.metadata.pid:'preview'" style="border: none;"
            *ngIf="previewFileKey"></iframe>
        </div>
      </div>
    </div>
  </div>
</ng-container>
