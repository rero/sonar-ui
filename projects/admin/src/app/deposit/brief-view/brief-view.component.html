<!--
 SONAR UI
 Copyright (C) 2019 RERO

 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU Affero General Public License as published by
 the Free Software Foundation, version 3 of the License.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 GNU Affero General Public License for more details.

 You should have received a copy of the GNU Affero General Public License
 along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<ng-container *ngIf="record">
  <h4 *ngIf="record.metadata.metadata; else defaultTitle">{{ record.metadata.metadata.title }}</h4>
  <ng-template #defaultTitle>
    <h4>{{ 'Deposit #' }}{{ record.metadata.pid }}</h4>
  </ng-template>
  <div class="my-2" [ngSwitch]="record.metadata.status">
    <span class="badge badge-info" *ngSwitchCase="'in progress'">{{
      record.metadata.status | translate
    }}</span>
    <span class="badge badge-warning" *ngSwitchCase="'to validate'">{{
      record.metadata.status | translate
    }}</span>
    <span class="badge badge-success" *ngSwitchCase="'validated'">{{
      record.metadata.status | translate
    }}</span>
    <span class="badge badge-danger" *ngSwitchCase="'rejected'">{{
      record.metadata.status | translate
    }}</span>
  </div>

  <div
    class="my-2 text-justify"
    *ngIf="record.metadata.metadata && record.metadata.metadata.abstracts"
  >
    {{ record.metadata.metadata.abstracts[0] | truncateText: 50 }}
  </div>

  <p>
    <span class="badge badge-primary">{{ 'ID' | translate }}: #{{ record.metadata.pid }}</span>
    <span class="badge badge-primary ml-1">
      {{ 'Created by' | translate }}: {{ record.metadata.user.first_name }}
      {{ record.metadata.user.last_name }}
    </span>
    <span class="badge badge-primary ml-1">
      {{ 'Created at' | translate }}: {{ record.created | dateTranslate: 'medium' }}
    </span>
    <span class="badge badge-primary ml-1">
      {{ 'Updated at' | translate }}: {{ record.updated | dateTranslate: 'medium' }}
    </span>
  </p>

  <div class="my-2" *ngIf="user.is_moderator && record.metadata.logs">
    <button type="button" class="btn btn-secondary btn-sm" (click)="toggleHistory(record)">
      {{ 'History' | translate }}
    </button>
    <ng-container *ngIf="record.showHistory">
      <table class="table table-bordered table-sm mt-3">
        <thead>
          <tr>
            <th>{{ 'Action' | translate }}</th>
            <th>{{ 'Date' | translate }}</th>
            <th>{{ 'User' | translate }}</th>
            <th>{{ 'Comment' | translate }}</th>
          </tr>
        </thead>
        <tr *ngFor="let log of record.metadata.logs">
          <td>{{ log.action | ucfirst | translate }}</td>
          <td>{{ log.date | dateTranslate: 'medium' }}</td>
          <td>{{ log.user.first_name }} {{ log.user.last_name }}</td>
          <td [innerHtml]="log.comment | nl2br"></td>
        </tr>
      </table>
    </ng-container>
  </div>

  <div *ngIf="canContinueProcess()">
    <a
      href
      class="btn btn-primary btn-small"
      [routerLink]="['/deposit', record.metadata.pid, 'create']"
    >
      {{ 'Continue process' | translate }}
    </a>
  </div>

  <div *ngIf="canReview()">
    <a
      href
      class="btn btn-primary btn-small"
      [routerLink]="['/deposit', record.metadata.pid, 'metadata']"
    >
      {{ 'Review deposit' | translate }}
    </a>
  </div>
</ng-container>
